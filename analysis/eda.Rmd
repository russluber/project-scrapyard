---
title: "Exploratory Data Analysis"
author: "Russel Luber"
date: "2025-12-11"
output: html_document
editor_options: 
  markdown: 
    wrap: sentence
---

```{r}
library(tidyverse)
library(here)
```

Load in the data.

```{r}
fights <- read_csv(here("data/clean/fight_data.csv"))
```

# Data Validation

Snapshot of the columns, col types, and values.

```{r}
glimpse(fights)
```

## String Clean Up

Remove leading and trailing whitespace in entries from columns that are strings (characters).

```{r}
fights <- fights %>%
  mutate(across(where(is.character), ~ str_trim(.x, side="both")))
```

## Duplicate Rows

I built a fighter-centric dataset, which means the key is `(fighter_id, fight_id)`: one row per fighter per fight.

Any duplicate rows?

```{r}
fights %>%
  count(fighter_id, fight_id) %>%
  filter(n > 1)
```

No duplicate rows.
Good.

## Check the Dates

According to [Wikipedia](https://en.wikipedia.org/wiki/Ultimate_Fighting_Championship), the UFC debuted its first event on November 12, 1993.
Sanity check: there should be no fights in the dataset before that!

```{r}
fights %>%
  summarise(
    earliest_fight = min(date),
    latest_fight = max(date)
  )
```

The earliest fight in the dataset happened on March 11, 1994.
Great.

Just in case `summarise()` somehow missed anything:

```{r}
fights %>%
  filter(date < as.Date("1993-11-12") | date > Sys.Date()) %>%
  arrange(date)
```

Good.
No fight data before the UFC was founded and no future fight data that hasn't happened yet.

How many unique fights are there (that we have data on)?

```{r}
fights %>%
  summarise(n_unique_fights = n_distinct(fight_id))
```

8407 fights.
Since there are two fighters involved in every match, we have 16814 rows in our `d` dataframe in total.

Are there missing values (`NAs`) in the data?

```{r}
fights %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  pivot_longer(
    cols = everything(),
    names_to = "column",
    values_to = "na_count"
  ) %>%
  arrange(desc(na_count))
```

No missing data across all entries of the 47 columns.
- Need to review fetching and parsing scripts to ensure no missing data at this stage is a good thing.
- For each of the columns, did I replace `NANs` with something else?
Like a 0 maybe?

## Verify Results

Check that there are only four outcomes in each row of the `res` (result) column: Win (W), Loss (L), Draw (D), or No Contest (NC).

```{r}
fights %>%
  distinct(res) %>%
  arrange(desc(res))
```

Good.
There are only four outcomes, as expected.

In a fight, there are only 3 possible combinations of outcomes:

1.  One fighter wins, the other loses.
2.  The fight is ruled a draw, in which case both fighters get a "D" on their record.
3.  The fight is a no contest, in which case both fighters get an "NC" on their record.

```{r}
res_patterns <- fights %>%
  count(fight_id, res) %>%
  arrange(fight_id, res) %>%
  group_by(fight_id) %>%
  summarise(
    n_rows  = sum(n),
    pattern = paste0(res, ":", n, collapse = ","),
    .groups = "drop"
  ) %>%
  mutate(is_valid = n_rows == 2 & pattern %in% c("D:2", "NC:2", "L:1,W:1", "W:1,L:1"))

invalid_ids <- res_patterns %>% filter(!is_valid) %>% pull(fight_id)

offenders   <- fights %>% filter(fight_id %in% invalid_ids)
```

```{r}
summarise(offenders)
```

```{r}
# Check that ALL fights (unique fight_id) have valid entries for the res column
fights %>% distinct(fight_id) %>% count() %>% pull(n) %>% as.integer() == sum(res_patterns$is_valid)
```

No fight had two winners or two losers or only one no contest (or draw).
Every fight has a valid entry for the `res` column.

## Weight Classes

The UFC has 8 official weight classes for men:

1.  Flyweight
2.  Bantamweight
3.  Featherweight
4.  Lightweight
5.  Welterweight
6.  Middleweight
7.  Light Heavyweight
8.  Heavyweight

For women, the UFC has 4 official weight classes:

1.  Strawweight
2.  Flyweight
3.  Bantamweight
4.  Featherweight

And there's an additional weight class called "Catchweight", which is an agreed-upon weight limit for a fight that falls outside of the standard, officially-recognized weight classes.

-   A fight is usually in catchweight if one or both of the fighters "missed weight."

```{r}
fights %>%
  distinct(gender, weight_class) %>%
  arrange(gender, weight_class)
```

```{r}
# In the UFC, the Strawweight division has only ever been for women. No men's strawweight division. Verify that
fights %>% filter(gender == "Men" & weight_class == "Strawweight")
```

How many unique fights are there across `(gender, weight_class)` combinations?

```{r}
fights %>% 
  distinct(fight_id, gender, weight_class) %>% 
  count(gender, weight_class, sort = TRUE)
```

Set weight classes for men and women as factors.

```{r}
levels_all <- c("Strawweight", "Flyweight","Bantamweight","Featherweight","Lightweight",
  "Welterweight","Middleweight","Light Heavyweight","Heavyweight","Catchweight")
```

```{r}
fights <- fights %>%
  mutate(weight_class = factor(weight_class, levels = levels_all))
```

Set gender as factor.

```{r}
gender_levels = c("Men", "Women")
```

```{r}
fights <- fights %>%
  mutate(gender = factor(gender, levels = gender_levels))
```

## Count Variables Cannot Be Negative

Variables like `strikes_landed`, `ctrl_time_s`, `td_stuffed`, and many (in fact most) of the variables in the dataset can be 0 but can't be negative.

```{r}
summary_nonneg <- fights %>%
  summarise(across(where(is.numeric), ~ sum(. < 0, na.rm = TRUE))) %>%
  tidyr::pivot_longer(everything(), names_to = "column", values_to = "n_negatives") %>%
  mutate(nonneg_ok = n_negatives == 0) %>%
  arrange(nonneg_ok, desc(n_negatives))

summary_nonneg
```

Great.
No negative counts slipped their way into the dataset somehow.

# Subsetting the Data

The [Unified Rules of Mixed Martial Arts](https://www.ufc.com/unified-rules-mixed-martial-arts) was adopted November 2000.
So let's start from there.
Our data will include fights starting from UFC 28: High Stakes.

```{r}
unified_rules_adopted = "2000-11-01" # YYYY-MM-DD
```

```{r}
fights <- fights %>%
  filter(date >= as.Date(unified_rules_adopted))
```

How many unique fights now?

```{r}
fights %>%
  summarise(n_unique_fights = n_distinct(fight_id))
```

How many unique fighters?

```{r}
fights %>%
  summarise(n_unique_fighters = n_distinct(fighter_id))
```

How many rows have less than 5 significant strikes thrown?

```{r}
sum(fights$sig_strikes_thrown < 5, na.rm = TRUE)
```

What percent of the data is that?

```{r}
mean(fights$sig_strikes_thrown < 5, na.rm = TRUE)
```

4% of fights have fighters who threw less than 5 significant strikes.

What about just the plain old strikes thrown?

```{r}
sum(fights$strikes_thrown < 5, na.rm = TRUE)
```

```{r}
mean(fights$strikes_thrown < 5, na.rm = TRUE)
```

Around 3% of fights have fighters who threw less than 5 total strikes.

Good to know.

```{r}
mean(fights$strikes_thrown < 10, na.rm = TRUE)
```

```{r}
fights %>%
  filter(sig_strikes_thrown < 5)
```

# Data Summaries

Get an overall feel for the numeric data columns.

```{r}
fights %>%
  select(where(is.numeric)) %>%
  pivot_longer(everything(), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  summarise(
    n = sum(!is.na(value)),
    # missing = sum(is.na(value)), # already verified nothing missing
    mean = mean(value, na.rm = TRUE),
    sd = sd(value, na.rm = TRUE),
    min = min(value, na.rm = TRUE),
    q25 = quantile(value, 0.25, na.rm = TRUE),
    median = median(value, na.rm = TRUE),
    q75 = quantile(value, 0.75, na.rm = TRUE),
    max = max(value, na.rm = TRUE),
    .groups = "drop"
  )
```

Many of these columns have the same distributions due to correlations and the reciprocal nature of fights: two fighters, the `sig_strikes_landed` for fighter 1 in one row is going to be the `sig_strikes_landed_by_opp` in fighter 2's row for their fight (`fight_id`).

Striking and grappling fight data distributions:

```{r}
fights %>%
  select(sig_strikes_landed, kds_scored, tds_landed, ctrl_time_s,
         sig_strikes_landed_by_opp, kds_scored_by_opp, 
         tds_landed_by_opp, ctrl_time_s_for_opp) %>%
  pivot_longer(everything(), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  summarise(
    n = sum(!is.na(value)),
    # missing = sum(is.na(value)), # already verified nothing missing
    mean = mean(value, na.rm = TRUE),
    sd = sd(value, na.rm = TRUE),
    min = min(value, na.rm = TRUE),
    q25 = quantile(value, 0.25, na.rm = TRUE),
    median = median(value, na.rm = TRUE),
    q75 = quantile(value, 0.75, na.rm = TRUE),
    max = max(value, na.rm = TRUE),
    .groups = "drop"
  )
```

# Preliminary Plots

How are the fights distributed in terms of outcomes i.e. method of winning?

```{r}
fights %>%
  mutate(
    method_plot = fct_recode(method, "Doctor's Stoppage" = "TKO")
  ) %>%
  ggplot(aes(x = fct_infreq(method_plot), fill = method_plot)) +
  geom_bar() +
  scale_fill_brewer(palette = "Set2") +
  labs(
    x = "Method of Victory",
    y = "Number of fights"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none")
```

Is there a difference between "KO/TKO" and "TKO"?
Maybe `method_detail` will shed some light on this.

```{r}
fights %>%
  count(method, method_detail, sort = TRUE)
```

I'm just gonna fold the categories that aren't in the top 3 into "Other".

```{r}
fights %>%
  mutate(
    method_group = fct_lump_n(method, n = 3)
  ) %>%
  ggplot(aes(x = fct_infreq(method_group), fill = method_group)) +
  geom_bar() +
  scale_fill_brewer(palette = "Set2") +
  labs(
    x = "Method of Victory",
    y = "Number of fights"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none"
  )
```

How do the main methods of victory (Decision, Submission, KO/TKO) vary across weight class?

```{r}
# Step 1: Lump methods
fights_top3 <- fights %>%
  mutate(method_group = fct_lump_n(method, n = 3)) %>%
  filter(method_group != "Other")

# Step 2: Plot
ggplot(fights_top3, aes(x = weight_class, fill = method_group)) +
  geom_bar(position = "dodge") +
  scale_fill_brewer(palette = "Set2") +
  labs(
    x = "Weight Class",
    y = "Number of Fights",
    fill = "Method"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

### Striking

```{r}
library(ggplot2)

theme_striking <- function(base_size = 11, base_family = "sans") {
  theme_minimal(base_size = base_size, base_family = base_family) +
    theme(   
      # Titles
      plot.title = element_text(
        face = "bold",
        hjust = 0,
        size = base_size + 2
      ),
      plot.subtitle = element_text(
        hjust = 0,
        size = base_size
      ),
      plot.caption = element_text(
        hjust = 1,
        size  = base_size - 2,
        color = "grey40"
      ),
      
      # Axes
      axis.title.x = element_text(
        margin = margin(t = 8),
        face   = "bold"
      ),
      axis.title.y = element_text(
        margin = margin(r = 8),
        face   = "bold"
      ),
      axis.text.x = element_text(
        size  = base_size - 1,
        angle = 0,
        vjust = 1
      ),
      axis.text.y = element_text(
        size = base_size - 1
      ),
      
      # Grid lines: a bit lighter since striking plots can be busy
      panel.grid.major.x = element_line(linewidth = 0.25),
      panel.grid.major.y = element_line(linewidth = 0.25),
      panel.grid.minor   = element_blank(),
      
      # Facet strips
      strip.background = element_rect(
        fill  = "grey90",
        color = "grey70",
        linewidth = 0.5
      ),
      strip.text = element_text(
        face = "bold",
        size = base_size - 1
      ),
      
      # Legend
      legend.position = "right",
      legend.title    = element_text(face = "bold"),
      legend.text     = element_text(size = base_size - 1),
      
      # Margins
      plot.margin = margin(t = 10, r = 10, b = 10, l = 10)
    )
}
```

```{r}
# Strikes landed vs. strikes thrown - all fighters across all their fights
ggplot(fights, aes(x = strikes_thrown, y = strikes_landed)) +
  geom_point(alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0, linetype="dashed") +
  coord_equal() +
  labs(
    x = "Strikes Thrown",
    y = "Strikes Landed",
    title = "Strikes Landed vs. Strikes Thrown"
  )
```

```{r}
# Strikes landed vs. strikes thrown
sig_strikes_landed_vs_thrown_scatter <- ggplot(fights, aes(x = sig_strikes_thrown, y = sig_strikes_landed)) +
  geom_point(alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0, linetype="dashed", color = "chartreuse4", linewidth = 0.7) +
  coord_equal() +
  labs(
    x = "Significant Strikes Thrown",
    y = "Significant Strikes Landed",
    title = "Significant Strikes Landed vs. Significant Strikes Thrown"
  )

sig_strikes_landed_vs_thrown_scatter
```

```{r}
# ggsave(
#   filename = here("reports", "midterm", "figs", "sig_strikes_landed_vs_thrown_scatter.png"),
#   plot     = sig_strikes_landed_vs_thrown_scatter,
#   width    = 6,
#   height   = 4,
#   dpi      = 300,
#   bg       = "white"
# )
```

Strikes and significant strikes are correlated for sure.
In particular, *significant* strikes are a subset of strikes.

-   What counts as a "significant strike" in the UFC?

-   How is it different different from just a regular strike?

These definitions are inherently subjective.

```{r}
# Strikes landed vs. strikes thrown
ggplot(fights, aes(x = sig_strikes_thrown, y = sig_strikes_landed, color = weight_class)) +
  geom_point(alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0, linetype="dashed") +
  labs(
    x = "Significant Strikes Thrown",
    y = "Significant Strikes Landed",
    title = "Significant Strikes: Landed vs. Thrown by Weight Class"
  )
```

Looks like a mess.
Too many colors.

Visualize distribution of significant strike accuracy (for fights with more than 5 significant strikes thrown).

```{r}
# Include only fights where the fighter (pertaining to the row) threw more than 5 significant strikes
MIN_SIG_STRIKES_THROWN = 5

sig_strike_acc_hist <- fights %>%
  filter(sig_strikes_thrown >= MIN_SIG_STRIKES_THROWN) %>%
  mutate(sig_strike_acc = sig_strikes_landed / sig_strikes_thrown) %>%
  ggplot(aes(x = sig_strike_acc)) +
  geom_histogram(binwidth = 0.05, fill = "firebrick", color = "white") +
  labs(
    title = "Distribution of Signficant Strike Accuracy",
    x = "Significant Strike Accuracy",
    y = "Count"
  )

sig_strike_acc_hist
```

```{r}
# ggsave(
#   filename = here("reports", "midterm", "figs", "sig_strike_acc_hist.png"),
#   plot     = sig_strike_acc_hist,
#   width    = 6,
#   height   = 4,
#   dpi      = 300,
#   bg       = "white"
# )
```

```{r}
# Include only fights where the fighter (pertaining to the row) threw more than 5 significant strikes
MIN_SIG_STRIKES_THROWN = 5

fights_2 <- fights %>% 
  filter(sig_strikes_thrown > MIN_SIG_STRIKES_THROWN) %>%
  mutate(sig_strike_acc = sig_strikes_landed / sig_strikes_thrown)
```

```{r}
levels_men <- c(
  "Flyweight","Bantamweight","Featherweight","Lightweight",
  "Welterweight","Middleweight","Light Heavyweight","Heavyweight","Catchweight"
)
```

```{r}
sig_strike_acc_by_weight_men <- fights_2 %>%
  filter(gender == "Men") %>%
  mutate(weight_class = forcats::fct_relevel(weight_class, levels_men)) %>%
  ggplot(aes(x = sig_strike_acc, fill = weight_class)) +
  geom_histogram(binwidth = 0.05, color = "white", show.legend = FALSE) +
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  facet_wrap(~ weight_class, ncol = 3, drop = TRUE) +
  labs(
    title = "Men's Distribution of Signficant Strike Accuracy Across Weight Classes",
    x = "Significant Strike Accuracy",
    y = "Count"
  )

sig_strike_acc_by_weight_men
```

```{r}
# ggsave(
#   filename = here("reports", "midterm", "figs", "sig_strike_acc_by_weight_men.png"),
#   plot     = sig_strike_acc_by_weight_men,
#   width    = 8,
#   height   = 5,
#   dpi      = 300,
#   bg       = "white"
# )
```

```{r}
levels_women <- c(
  "Strawweight", "Flyweight", "Bantamweight", "Featherweight"
)
```

```{r}
sig_strike_acc_by_weight_women <- fights_2 %>%
  filter(gender == "Women") %>%
  mutate(weight_class = forcats::fct_relevel(weight_class, levels_women)) %>%
  ggplot(aes(x = sig_strike_acc, fill = weight_class)) +
  geom_histogram(binwidth = 0.05, color = "white", show.legend = FALSE) +
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  facet_wrap(~ weight_class, ncol = 2, drop = TRUE) +
  labs(
    title = "Women's Distribution of Signficant Strike Accuracy Across Weight Classes",
    x = "Significant Strike Accuracy",
    y = "Count"
  )

sig_strike_acc_by_weight_women
```

```{r}
# ggsave(
#   filename = here("reports", "midterm", "figs", "sig_strike_acc_by_weight_women.png"),
#   plot     = sig_strike_acc_by_weight_women,
#   width    = 8,
#   height   = 5,
#   dpi      = 300,
#   bg       = "white"
# )
```

Distribution of significant strikes landed vs. significant strikes avoided.

```{r}
sig_strikes_landed_vs_avoided_scatter <- fights_2 %>%
  ggplot(aes(x = sig_strikes_landed, y = sig_strikes_avoided)) +
  geom_point(alpha = 0.2, size = 1) +
  geom_abline(slope = 1, intercept = 0, linetype="dashed", color = "chartreuse4", linewidth = 0.7) +
  coord_equal() +
  labs(
    x = "Significant Strikes Landed",
    y = "Significant Strikes Avoided",
    title = "Significant Strikes: Landed vs. Avoided"
  )

sig_strikes_landed_vs_avoided_scatter
```

```{r}
# ggsave(
#   filename = here("reports", "midterm", "figs", "sig_strikes_landed_vs_avoided_scatter.png"),
#   plot     = sig_strikes_landed_vs_avoided_scatter,
#   width    = 8,
#   height   = 5,
#   dpi      = 300,
#   bg       = "white"
# )
```

From cursory inspection, it looks like quite a lot more significant strikes are avoided than are landed.

How does significant strike accuracy vary across fighters?
What is the mean significant strike accuracy for each of the fighters?
What does that distribution look like?
- Here I'm looking at fighters who have fought at least 3 times across their career (so far).

```{r}
MIN_NUM_FIGHTS = 3

per_fighter <- fights_2 %>%
  group_by(fighter_id, fighter) %>%
  summarize(
    mean_sig_acc = mean(sig_strike_acc, na.rm = TRUE),
    num_fights = n(),
    .groups = "drop"
  )

per_fighter %>%
  filter(num_fights >= MIN_NUM_FIGHTS) %>%
  filter(is.finite(mean_sig_acc), between(mean_sig_acc, 0, 1)) %>%
  ggplot(aes(x = mean_sig_acc)) +
  geom_histogram(binwidth = 0.05, color = "white") +
  scale_x_continuous(labels = scales::percent_format(1)) +
  labs(title = "Per-Fighter Mean Significant Strike Accuracy",
       x = "Mean Accuracy", y = "Count") +
  theme_striking()
```

This is the average of fight significant strike accuracies.

-   Compute significant strike accuracy per fight, then average across a fighter's fights.

-   Every fight gets equal weight, no matter how many significant strikes were thrown.

```{r}
per_fighter_weighted <- fights_2 %>%
  group_by(fighter_id, fighter) %>%
  summarize(
    total_landed = sum(sig_strikes_landed, na.rm = TRUE),
    total_thrown = sum(sig_strikes_thrown, na.rm = TRUE),
    overall_sig_acc = if_else(total_thrown > 0, total_landed / total_thrown, NA_real_),
    num_fights = n(),
    .groups = "drop"
  )

per_fighter_weighted %>%
  filter(num_fights >= MIN_NUM_FIGHTS) %>%
  filter(is.finite(overall_sig_acc), between(overall_sig_acc, 0, 1)) %>%
  ggplot(aes(x = overall_sig_acc)) +
  geom_histogram(binwidth = 0.05, color = "white") +
  scale_x_continuous(labels = scales::percent_format(1)) +
  labs(title = "Per-Fighter Overall Significant Strike Accuracy",
       x = "Overall accuracy", y = "Count") +
  theme_striking()
```

This is overall accuracy.
The number of significant strikes landed across all fights of a fighter divided by the number of significant strikes thrown across all fights by said fighter.
- Pool all landed and all thrown, then take one ratio.
- This number is weighted by the number of significant strikes thrown.

The basic accuracy metric of each fighter, for each fight, will be the ratio between the amount of strikes (punches, kicks, knees, elbows) that hit the opponent and the total number of strikes they threw.

$$\text{striking accuracy} = \frac{\text{strikes landed}}{\text{strikes thrown}}$$

Import caveat: What counts as a strike and how does the UFC count a strike?
- There's a lot of subjectivity to this.

-   The way it works it that there's probably a few people at these live events whose job is to count the number of strikes thrown and landed. Then they review the footage afterward and correct their tallies, maybe? Not entirely sure. Need to read up on that.
    -   What is the difference between a strike and a significant strike? What makes a strike significant? Need to understand that distinction.

All fighters, across all their fights, are never 100% accurate with their strikes.
They always throw more strikes than they land.
Captain Obvious over here, but good to know we can see it in the data.

Significant Strike Differential.
What if we look at the difference between the number of significant strikes landed between the fighters in each fight?

```{r}
fights_2 %>%
  ggplot(aes(x = sig_strikes_landed, y = sig_strikes_landed_by_opp)) +
  geom_point(alpha = 0.2, size = 1) +
  coord_equal() +
  labs(
    x = "Significant Strikes Landed by Fighter",
    y = "Significant Strikes Landed by their Opponent",
    title = "Significant Strike Differentials"
  ) +
  theme_striking()
```

Can we see separation in weight classes here?

```{r}
fights_2 %>%
  ggplot(aes(x = sig_strikes_landed, 
             y = sig_strikes_landed_by_opp, 
             fill = weight_class,
             color = weight_class)) +
  geom_point(alpha = 0.2, size = 1) +
  coord_equal() +
  labs(
    x = "Significant Strikes Landed by Fighter",
    y = "Significant Strikes Landed by their Opponent",
    title = "Significant Strike Differentials"
  ) +
  theme_striking()
```

Can't really see a clear pattern here.

Any interesting correlations to investigate?

### Grappling

What about ctrl time?
Maybe look at grappling?

How many fights have `ctrl_time_s` \> 0?
How many fights had the element of ground game in them?

```{r}
fights %>%
  count(ctrl_time_s > 0)
```

That's quiet a lot.
It makes sense that mixed martial artists, well, mix the martial arts and not just strike.

```{r}
sum(fights$ctrl_time_s > 0) / count(fights)
```

84% of the fights we have in the dataset (from when the unified rules were adopted to November 15, 2025).

What about the percentage of fights that have at least 60 seconds of control time.

```{r}
sum(fights$ctrl_time_s >= 60) / count(fights)
```

Oof.
Looks like about 50% of the fights.
Half of the fights have control time under 1 min.
So most of the fights have quick grappling game.

What about 30s?

```{r}
sum(fights$ctrl_time_s >= 30) / count(fights)
```

```{r}
fights %>%
  select(ctrl_time_s) %>%
  pivot_longer(everything(), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  summarise(
    n = sum(!is.na(value)),
    # missing = sum(is.na(value)), # already verified nothing missing
    mean = mean(value, na.rm = TRUE),
    sd = sd(value, na.rm = TRUE),
    min = min(value, na.rm = TRUE),
    q25 = quantile(value, 0.25, na.rm = TRUE),
    median = median(value, na.rm = TRUE),
    q75 = quantile(value, 0.75, na.rm = TRUE),
    max = max(value, na.rm = TRUE),
    .groups = "drop"
  )
```

So the median control time in seconds across all fights is about 60.

Does control time differ by weight class?

```{r}
ggplot(fights, aes(x = weight_class, y = ctrl_time_s)) +
  geom_boxplot() +
  labs(
    x = "Weight class",
    y = "Control time (seconds)"
  ) +
  coord_flip()
```

Most fighters have 0 to 60 seconds in a fight, but it looks like a few fighters have massive amounts (in the hundreds and thousands of seconds).
These are "outliers" here are fighters with grappling-heavy styles.

```{r}
ggplot(fights, aes(x = weight_class, y = ctrl_time_s)) +
  geom_violin() +
  labs(
    x = "Weight class",
    y = "Control time (seconds)"
  ) +
  coord_flip()
```

# Career (Survival Analysis)

```{r}
library(dplyr)
library(lubridate)
```

```{r}
today <- as_date(Sys.Date())         # or fix a reference date
inactive_cutoff_years <- 2

# careers <- fights %>%
#   filter(sig_strikes_thrown > 0) %>%              # drop zero-throw rows entirely
#   group_by(fighter_id) %>%
#   summarise(
#     fighter       = first(fighter),
#     gender        = first(gender),
#     weight_class  = first(weight_class),
#     first_fight   = min(date),
#     last_fight    = max(date),
#     n_fights      = n(),
#     mean_accuracy = mean(sig_strikes_landed / sig_strikes_thrown),
#     .groups = "drop"
#   ) %>%
#   mutate(
#     career_length_years = as.numeric(last_fight - first_fight) / 365,
#     inactive_years      = as.numeric(today - last_fight) / 365,
#     event               = if_else(inactive_years >= inactive_cutoff_years, 1, 0)
#   ) %>%
#   filter(n_fights >= 3)

### DROPPED FIGHTS WHERE THERE WERE NO SIG STRIKES THROWN AND ONLY INCLUDED FIGHTERS WITH AT LEAST 3 FIGHTS


### THIS IS THE ORIGINAL ONE:
careers <- fights %>%
  group_by(fighter_id) %>%
  summarise(
    fighter = first(fighter),
    gender = first(gender),
    weight_class = first(weight_class),
    first_fight = min(date),
    last_fight = max(date),
    n_fights = n()
  ) %>%
  mutate(
    career_length_years = as.numeric(last_fight - first_fight) / 365,
    inactive_years = as.numeric(today - last_fight) / 365,
    event = if_else(inactive_years >= inactive_cutoff_years, 1, 0)
  )
```

```{r}
today <- as_date(Sys.Date())
inactive_cutoff_years <- 2

careers <- fights %>%
  group_by(fighter_id) %>%
  summarise(
    fighter       = first(fighter),
    gender        = first(gender),
    weight_class  = first(weight_class),
    first_fight   = min(date),
    last_fight    = max(date),
    n_fights      = n(),

    # NEW: how much damage they took across UFC career
    total_absorbed = sum(sig_strikes_landed_by_opp, na.rm = TRUE),
    absorbed_per_fight = mean(sig_strikes_landed_by_opp, na.rm = TRUE),

    .groups = "drop"
  ) %>%
  mutate(
    career_length_years = as.numeric(last_fight - first_fight) / 365,
    inactive_years      = as.numeric(today - last_fight) / 365,
    event               = if_else(inactive_years >= inactive_cutoff_years, 1, 0)
  )

```

```{r}
cor(careers$career_length_years, careers$total_absorbed, use = "complete.obs")
```

```{r}
cor(careers$career_length_years, careers$absorbed_per_fight, use = "complete.obs")
```

```{r}
ggplot(careers, aes(x = career_length_years, y = total_absorbed)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", color = "red") +
  labs(
    title = "Career Length vs Total Strikes Absorbed",
    x = "Career Length (years)",
    y = "Total Strikes Absorbed"
  )

```

If `event` is 1, then the fighter has been inactive for at least 2 years.
Otherwise, if `event` is 0, then the fighter has been inactive for less than that.
We treat this as still active, so the observation is right censored.

```{r}
careers %>%
  count(event)
```

```{r}
library(ggplot2)

theme_careers <- function(base_size = 12, base_family = "sans") {
  theme_minimal(base_size = base_size, base_family = base_family) +
    theme(
      # Titles and subtitles
      plot.title = element_text(
        face = "bold",
        hjust = 0,
        size = base_size + 2
      ),
      plot.subtitle = element_text(
        hjust = 0,
        size = base_size
      ),
      
      # Axis titles and text
      axis.title.x = element_text(
        margin = margin(t = 8),
        face = "bold"
      ),
      axis.title.y = element_text(
        margin = margin(r = 8),
        face = "bold"
      ),
      axis.text = element_text(size = base_size - 1),
      
      # Panel grid lines
      panel.grid.major.x = element_line(linewidth = 0.3),
      panel.grid.major.y = element_line(linewidth = 0.3),
      panel.grid.minor = element_blank(),
      
      # Legend
      legend.position = "bottom",
      legend.title = element_blank(),
      legend.text = element_text(size = base_size - 1),
      
      # Plot margins
      plot.margin = margin(t = 10, r = 10, b = 10, l = 10)
    )
}

```

```{r}
career_length_hist <- ggplot(careers, aes(career_length_years)) +
  geom_histogram(binwidth = 1, fill = "steelblue", color = "white") +
  labs(
    title = "Distribution of UFC Career Lengths",
    x = "Career Length (years)",
    y = "Number of Fighters"
  ) +
  theme_careers()

career_length_hist
```

```{r}
# ggsave(
#   filename = here("reports", "midterm", "figs", "career_length_hist.png"),
#   plot     = career_length_hist,
#   width    = 8,
#   height   = 5,
#   dpi      = 300,
#   bg       = "white"
# )
```

```{r}
ggplot(careers, aes(x = career_length_years, y = mean_accuracy)) +
  geom_point(alpha = 0.5, color = "steelblue") +
  geom_smooth(method = "lm", se = TRUE, color = "red") +
  labs(
    title = "Career Length vs Mean Sig Strike Accuracy",
    x = "Career Length (years)",
    y = "Mean Sig Strike Accuracy"
  ) +
  theme_careers()
```

```{r}
career_length_by_weight_boxplot <- ggplot(careers, aes(x = weight_class, y = career_length_years, fill = weight_class)) +
  geom_boxplot(show.legend = FALSE) +
  coord_flip() +
  labs(
    title = "Career Length by Weight Class",
    x = "Weight Class",
    y = "Career Length (years)"
  ) +
  scale_fill_brewer(palette = "Set3") +
  theme_careers()

career_length_by_weight_boxplot
```

```{r}
ggsave(
  filename = here("reports", "midterm", "figs", "career_length_by_weight_boxplot.png"),
  plot     = career_length_by_weight_boxplot,
  width    = 8,
  height   = 5,
  dpi      = 300,
  bg       = "white"
)
```

```{r}
ggplot(careers, aes(n_fights, career_length_years)) +
  geom_point(alpha = 0.3) +
  labs(
    title = "Number of UFC Fights vs Career Length",
    x = "Total UFC Fights",
    y = "Career Length (years)"
  ) +
  theme_careers()
```

```{r}
library(survival)
library(survminer)

km <- survfit(Surv(career_length_years, event) ~ 1, data = careers)

ggsurvplot(
  km,
  conf.int = TRUE,
  risk.table = TRUE,
  xlab = "Career length (years)",
  ylab = "Proportion still active",
  title = "Survival Curve for UFC Careers"
)
```

# Model-Ready Data

Since we're building a model to estimate the striking ability of fighters, we need to drop rows where there were no significant strikes thrown.
We use the ratio between the significant strikes landed and thrown as noisy-but-good-enough measures of each fighter's offensive ability in a fight.
Similarly, we use the ratio between the significant strikes landed and thrown by the opponent as a measure of each fighter's defensive ability.

## Multiple Logistic Regression Model

Which fight performance differential is the most predictive of winning?

To what extent do performance differentials predict winning in the UFC?

```{r}
win_df <- read_rds(here("data", "model", "win_perf_diffs_df.rds"))
```

```{r}
perf_diff_model <- glm(
  res_win ~ sig_strike_diff_z + kd_diff_z + td_diff_z + ctrl_time_diff_z,
  data = win_df,
  family = binomial()
)

summary(perf_diff_model)
```

```{r}
library(broom)
library(ggplot2)

or_df <- tidy(perf_diff_model, exponentiate = TRUE, conf.int = TRUE) %>%
  filter(term != "(Intercept)")

ggplot(or_df, aes(x = reorder(term, estimate), y = estimate)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.1) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
  coord_flip() +
  labs(
    title = "Odds Ratios for Performance Differentials",
    x = "Predictor (1 SD increase)",
    y = "Odds Ratio (log scale)"
  ) +
  scale_y_log10()

```

Logistic regression analysis revealed that performance differentials strongly predict fight outcomes.
A one-SD increase in significant strike differential increased the odds of winning nearly eightfold, making it the dominant predictor.
Knockdown differential was the next most influential factor, multiplying the odds of victory by almost four.
Takedown differential had a moderate effect, increasing the odds by about 57 percent.
In contrast, control time differential had essentially no independent predictive value once striking and grappling differentials were included.
These findings align with modern MMA judging criteria, where effective striking carries the greatest weight, followed by impactful grappling actions, with control time used only as a secondary tiebreaker.

```{r}
library(car)
vif(perf_diff_model)
```

Logistic regression using the four standardized performance differentials achieved a McFadden pseudo-R² of 0.49, indicating a very strong model fit.
Nearly half of the explainable variation in fight outcomes is captured by these four predictors alone.

```{r}
library(pROC)

win_df$pred_prob <- predict(perf_diff_model, type="response")
```

```{r}
roc_obj <- roc(win_df$res_win, win_df$pred_prob)
```

```{r}
auc_value <- auc(roc_obj)
auc_value
```

```{r}
plot(roc_obj,
     col = "#0c7bdc",
     lwd = 3,
     main = "ROC Curve for UFC Performance Differential Model")

abline(a = 0, b = 1, lty = 2, col = "gray50")

```

The model’s ability to discriminate winners from losers was evaluated using a receiver operating characteristic (ROC) curve.
The resulting area under the curve (AUC) was 0.924, indicating outstanding discriminating performance.
This implies that in 92.4 percent of all winner–loser pairs, the model correctly assigns a higher predicted win probability to the actual winner.
The ROC curve rises sharply toward the upper-left corner, confirming that even simple performance differentials (significant strikes, knockdowns, takedowns, and control time) provide strong predictive power for identifying the winner of a UFC fight.

```{r}
glm(res_win ~ ctrl_time_diff, family = binomial(), data = win_df)
```
