---
title: "Exploratory Data Analysis"
author: "Russel Luber"
date: "2025-11-04"
output: html_document
---

```{r}
library(tidyverse)
library(here)
```

Load in the data

```{r}
d <- read_csv(here("data/clean/fight_data.csv"))
```


# Data Validation

Snapshot of the columns, col types, and values
```{r}
glimpse(d)
```

## String Clean Up

Remove leading and trailing whitespace in entries from columns that are strings (characters).

```{r}
d <- d %>%
  mutate(across(where(is.character), ~ str_trim(.x, side="both")))
```


## Duplicate Rows

I built a fighter-centric dataset, which means the key is `(fighter_id, fight_id)`: one row per fighter per fight. Let's verify that.

Any duplicate rows?

```{r}
d %>% count(fighter_id, fight_id) %>% filter(n > 1)
```

No duplicate rows. Good.

## Check the Dates

According to [Wikipedia] (https://en.wikipedia.org/wiki/Ultimate_Fighting_Championship), the UFC was founded on November 12, 1993. Sanity check: there should be no fights in the dataset before that!

```{r}
d %>%
  summarise(
    earliest_fight = min(date),
    latest_fight = max(date)
  )
```

The earliest fight in the dataset happened on March 11, 1994. Great.


Just in case `summarise()` somehow missed anything:
```{r}
d %>%
  filter(date < as.Date("1993-11-12") | date > Sys.Date()) %>%
  arrange(date)
```

Good. No fight data before the UFC was founded and no future fight data that hasn't happened yet.


How many unique fights are there (that we have data on)?

```{r}
d %>%
  summarise(n_unique_fights = n_distinct(fight_id))
```

8407 fights. Since there are two fighters involved in every match, we have 16814 rows in our `d` dataframe in total.

Are there missing values (`NANs`) in the data?

```{r}
d %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  pivot_longer(
    cols = everything(),
    names_to = "column",
    values_to = "na_count"
  ) %>%
  arrange(desc(na_count))
```

No missing data across all entries of the 47 columns.
- Need to review fetching and parsing scripts to ensure no missing data at this stage is a good thing.
- For each of the columns, did I replace `NANs` with something else? Like a 0 maybe?

## Verify Results

Check that there are only four outcomes in each row of the `res` (result) column: Win (W), Loss (L), Draw (D), or No Contest (NC). 

```{r}
d %>%
  distinct(res) %>%
  arrange(desc(res))
```

Good. There are only four outcomes, as expected.

In a fight, there are only 3 possible combinations of outcomes:

1. One fighter wins, the other loses.
2. The fight is ruled a draw, in which case both fighters get a "D" on their record.
3. The fight is a no contest, in which case both fighters get an "NC" on their record.

```{r}
res_patterns <- d %>%
  count(fight_id, res) %>%
  arrange(fight_id, res) %>%
  group_by(fight_id) %>%
  summarise(
    n_rows  = sum(n),
    pattern = paste0(res, ":", n, collapse = ","),
    .groups = "drop"
  ) %>%
  mutate(is_valid = n_rows == 2 & pattern %in% c("D:2", "NC:2", "L:1,W:1", "W:1,L:1"))

invalid_ids <- res_patterns %>% filter(!is_valid) %>% pull(fight_id)

offenders   <- d %>% filter(fight_id %in% invalid_ids)
```


```{r}
summarise(offenders)
```

```{r}
# Check that ALL fights (unique fight_id) have valid entries for the res column
d %>% distinct(fight_id) %>% count() %>% pull(n) %>% as.integer() == sum(res_patterns$is_valid)
```

No fight had two winners or two losers or only one no contest (or draw). Every fight has a valid entry for the `res` column.

## Weight Classes

The UFC has 8 official weight classes for men: 

1. Flyweight
2. Bantamweight
3. Featherweight
4. Lightweight
5. Welterweight
6. Middleweight
7. Light Heavyweight
8. Heavyweight


For women, the UFC has 4 official weight classes:
1. Strawweight
2. Flyweight
3. Bantamweight
4. Featherweight


And there's an additional weight class called "Catchweight", which is an agreed-upon weight limit for a fight that falls outside of the standard, officially-recognized weight classes.
- A fight is usually in catchweight if one or both of the fighters "missed weight."

```{r}
d %>%
  distinct(gender, weight_class) %>%
  arrange(gender, weight_class)
```


```{r}
# In the UFC, the Strawweight division has only ever been for women. No men's strawweight division. 
d %>% filter(gender == "Men" & weight_class == "Strawweight")
```

How many unique fights are there across `(gender, weight_class)` combinations?

```{r}
d %>% 
  distinct(fight_id, gender, weight_class) %>% 
  count(gender, weight_class, sort = TRUE)
```

Set weight classes for men and women as factors.

```{r}
levels_all <- c("Strawweight", "Flyweight","Bantamweight","Featherweight","Lightweight",
  "Welterweight","Middleweight","Light Heavyweight","Heavyweight","Catchweight")
```

```{r}
d <- d %>%
  mutate(weight_class = factor(weight_class, levels = levels_all))
```



## Count Variables Cannot Be Negative

Variables like `strikes_landed`, `ctrl_time_s`, `td_stuffed`, and many (in fact most) of the variables in the dataset can be 0 but can't be negative.

```{r}
summary_nonneg <- d %>%
  summarise(across(where(is.numeric), ~ sum(. < 0, na.rm = TRUE))) %>%
  tidyr::pivot_longer(everything(), names_to = "column", values_to = "n_negatives") %>%
  mutate(nonneg_ok = n_negatives == 0) %>%
  arrange(nonneg_ok, desc(n_negatives))

summary_nonneg
```

Great. No negative counts slipped their way into the dataset somehow.


# Subsetting the Data

The [Unified Rules of Mixed Martial Arts](https://www.ufc.com/unified-rules-mixed-martial-arts) was adopted November 2000. So let's start from there. Our data will include fights starting from UFC 28: High Stakes.

```{r}
unified_rules_adopted = "2000-11-01" # YYYY-MM-DD
```


```{r}
d <- d %>%
  filter(date >= as.Date(unified_rules_adopted))
```



```{r}
sum(d$sig_strikes_thrown < 5, na.rm = TRUE)
```

```{r}
mean(d$sig_strikes_thrown < 5, na.rm = TRUE)
```

4% of fights have fighters who threw less than 5 significant strikes.

```{r}
sum(d$strikes_thrown < 5, na.rm = TRUE)
```


```{r}
mean(d$strikes_thrown < 5, na.rm = TRUE)
```

Around 3% of fights have fighters who threw less than 5 total strikes.


Good to know.

```{r}
# Strikes landed vs. strikes thrown - all fighters across all their fights
ggplot(d, aes(x = strikes_thrown, y = strikes_landed)) +
  geom_point(alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0, linetype="dashed") +
  coord_equal() +
  labs(
    x = "Strikes Thrown",
    y = "Strikes Landed",
    title = "Strikes Landed vs. Strikes Thrown"
  )
```



```{r}
# Strikes landed vs. strikes thrown
ggplot(d, aes(x = sig_strikes_thrown, y = sig_strikes_landed)) +
  geom_point(alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0, linetype="dashed") +
  coord_equal() +
  labs(
    x = "Significant Strikes Thrown",
    y = "Significant Strikes Landed",
    title = "Significant Strikes Landed vs. Significant Strikes Thrown"
  )
```





```{r}
# Include only fights where the fighter (pertaining to the row) threw more than 5 significant strikes
MIN_SIG_STRIKES_THROWN = 5

d %>%
  filter(sig_strikes_thrown >= MIN_SIG_STRIKES_THROWN) %>%
  mutate(sig_strike_acc = sig_strikes_landed / sig_strikes_thrown) %>%
  ggplot(aes(x = sig_strike_acc)) +
  geom_histogram(binwidth = 0.05, fill = "firebrick", color = "white") +
  labs(
    title = "Distribution of Signficant Strike Accuracy",
    x = "Significant Strike Accuracy",
    y = "Count"
  )
```

```{r}
# Include only fights where the fighter (pertaining to the row) threw more than 5 significant strikes
MIN_SIG_STRIKES_THROWN = 5

d2 <- d %>% 
  filter(sig_strikes_thrown > MIN_SIG_STRIKES_THROWN) %>%
  mutate(sig_strike_acc = sig_strikes_landed / sig_strikes_thrown)
```


```{r}
levels_men <- c(
  "Flyweight","Bantamweight","Featherweight","Lightweight",
  "Welterweight","Middleweight","Light Heavyweight","Heavyweight","Catchweight"
)
```


```{r}
d2 %>%
  filter(gender == "Men") %>%
  mutate(weight_class = forcats::fct_relevel(weight_class, levels_men)) %>%
  ggplot(aes(x = sig_strike_acc, fill = weight_class)) +
  geom_histogram(binwidth = 0.05, color = "white", show.legend = FALSE) +
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  facet_wrap(~ weight_class, ncol = 3, drop = TRUE) +
  labs(
    title = "Men's Distribution of Signficant Strike Accuracy Across Weight Classes",
    x = "Significant Strike Accuracy",
    y = "Count"
  )
```

```{r}
levels_women <- c(
  "Strawweight", "Flyweight", "Bantamweight", "Middleweight"
)
```


```{r}
d2 %>%
  filter(gender == "Women") %>%
  mutate(weight_class = forcats::fct_relevel(weight_class, levels_women)) %>%
  ggplot(aes(x = sig_strike_acc, fill = weight_class)) +
  geom_histogram(binwidth = 0.05, color = "white", show.legend = FALSE) +
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  facet_wrap(~ weight_class, ncol = 2, drop = TRUE) +
  labs(
    title = "Women's Distribution of Signficant Strike Accuracy Across Weight Classes",
    x = "Significant Strike Accuracy",
    y = "Count"
  )
```




> Stopped here. Anything below is not good.

Let's exclude fighters who've only fought once or twice.

```{r}
MIN_NUM_FIGHTS = 3

data <- d %>%
  distinct(fighter_id, fight_id, .keep_all = TRUE) %>%
  group_by(fighter_id) %>%
  filter(n_distinct(fight_id) >= MIN_NUM_FIGHTS) %>%
  ungroup()
```


Let's inspect fighters who have only fought once or twice.

```{r}
newbs <- d %>%
  distinct(fighter_id, fight_id, .keep_all = TRUE) %>%
  group_by(fighter_id) %>%
  filter(n_distinct(fight_id) < MIN_NUM_FIGHTS) %>%
  ungroup()
```

There are 1069 rows for newbies (fighter-centric). 


## Defining New Variables

Transform some variables to get striking accuracy measures.

The basic accuracy metric of each fighter, for each fight, will be the ratio between the amount of strikes (punches, kicks, knees, elbows) that hit the opponent and the total number of strikes they threw.

$$\text{striking accuracy} = \frac{\text{strikes landed}}{\text{strikes thrown}}$$
Import caveat: What counts as a strike and how does the UFC count a strike?
- There's a lot of subjectivity to this.
- The way it works it that there's probably a few people at these live events whose job is to count the number of strikes thrown and landed. Then they review the footage afterward and correct their tallies, maybe? Not entirely sure. Need to read up on that.
- What is the difference between a strike and a significant strike? What makes a strike significant? Need to understand that distinction.


```{r}
data <- data %>%
  # Retain striking and striking-relevant variables only + contextual variables for now
  select(
    -any_of(
      c("tds_landed", "tds_attempted", "tds_stuffed", "subs_attempted", "reversals", "ctrl_time_s",
        "tds_landed_by_opp", "subs_attempted_by_opp", "reversals_by_opp", "ctrl_time_s_for_opp")
      )
  ) %>%
  # Create striking metrics
  mutate(
    # Offensive strike metrics against opponent
    striking_accuracy = if_else(strikes_thrown > 0, strikes_landed / strikes_thrown, 0),
    sig_strikes_accuracy = if_else(sig_strikes_thrown > 0, sig_strikes_landed / sig_strikes_thrown, 0),
    sig_strikes_prop = if_else(sig_strikes_thrown > 0, sig_strikes_thrown / strikes_thrown, 0),
    volume_strikes_accuracy = if_else(volume_strikes_thrown > 0, volume_strikes_landed / volume_strikes_thrown, 0),
    # Defensive strike metrics for fighter
    strikes_avoided_prop = if_else(strikes_thrown_by_opp > 0, strikes_avoided / strikes_thrown_by_opp, 0),
    sig_strikes_avoided_prop = if_else(sig_strikes_thrown_by_opp > 0, sig_strikes_avoided / sig_strikes_thrown_by_opp, 0),
    volume_strikes_avoided_prop = if_else(volume_strikes_thrown_by_opp > 0,
                                          volume_strikes_avoided / volume_strikes_thrown_by_opp, 0),
    # Striking damage metrics against fighter
    strikes_absorbed_prop = if_else(strikes_thrown_by_opp > 0, strikes_landed_by_opp / strikes_thrown_by_opp, 0),
    sig_strikes_absorbed_prop = if_else(sig_strikes_thrown_by_opp > 0, 
                                        sig_strikes_landed_by_opp/ sig_strikes_thrown_by_opp, 0),
    volume_strikes_absorbed_prop = if_else(volume_strikes_thrown_by_opp > 0,
                                           volume_strikes_landed_by_opp / volume_strikes_thrown_by_opp, 0)
  )
```



```{r}
data %>%
  summarise(mean_sig_strike_acc = mean(sig_strikes_accuracy, na.rm = TRUE),
            .by = fighter) %>%
  arrange(desc(mean_sig_strike_acc))
```


## Preliminary Plots

```{r}
library(ggplot2)
```


```{r}
# Strikes landed vs. strikes thrown - all fighters across all their fights
ggplot(data, aes(x = strikes_thrown, y = strikes_landed)) +
  geom_point(alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0, linetype="dashed") +
  coord_equal() +
  labs(
    x = "Strikes Thrown",
    y = "Strikes Landed",
    title = "Strikes Landed vs. Strikes Thrown"
  )
```

All fighters, across all their fights, are never 100% accurate with their strikes. They always throw more strikes than they land. Captain Obvious over here, but good to know we can see it in the data.



```{r}
# Significant strikes landed vs strikes thrown
ggplot(data, aes(x = strikes_thrown, y = sig_strikes_landed)) +
  geom_point()
```


```{r}
# Strikes landed vs. strikes thrown by weight class
ggplot(data, aes(x = strikes_thrown, y = sig_strikes_landed)) +
  geom_point(alpha = 0.6) +
  facet_wrap(~ weight_class, ncol = 3)
```

Basic finding: Fighters thrown more than they land (obviously). 


```{r}
ggplot(data, aes(striking_accuracy)) +
  geom_histogram(bins = 30)
```

Need to fix the 0.0 and 1.0 accuracies. 0 fights or 1 fight Andys.


```{r}
ggplot(data, aes(sig_strikes_accuracy)) +
  geom_histogram(bins = 30)
```




```{r}
sum(isna(data$sig_strikes_accuracy))
```



Do fighters tend to land more than their opponent?

```{r}
ggplot(data, aes(x = strikes_thrown, y = strikes_thrown_by_opp)) +
  geom_point()
```


```{r}
ggplot(data, aes(sig_strikes_accuracy)) +
  geom_histogram(bins = 30) +
  facet_wrap(~ method)
```




# Model-Ready Data


Since we're building a model to estimate the striking ability of fighters, we need to drop rows where there were no significant strikes thrown. We use significant strikes thrown and landed as noisy-but-good-enough measures of each fighter's offensive ability in a fight. Defensive ability is 

```{r}
sum(d$sig_strikes_thrown == 0)
```



```{r}
d %>%
  filter(sig_strikes_thrown == 0)
```






























































